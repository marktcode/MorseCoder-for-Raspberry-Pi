#!/bin/sh
#compress a text message.
PATH=$PATH:.:..

# check number of arguments
case $# in
1) FILE=$1;;
0) echo usage: cmprs file name
    exit ;;
esac

tc_new -f cmprsalpha > /dev/null
USER=42771136134044521272115527460050466
tc_decomp -f cmprsalpha `echo $USER | rev | awk '{ printf "obase=2;ibase=8; %s\n", $1}' | bc | tr -d "\n\\\" 2> /dev/null | rev` 

#while true 
#do
read -p "Enter message:" MESSAGE
if test "$MESSAGE"
then

WRDCNT=0
for WORD in `echo "$MESSAGE" | sed -e '/ \. /s// qspc qprd /g' -e '/\. /s// qprd /g' -e '/\./s// qprd qbs /g' \
-e '/ , /s// qspc qcma /g' -e '/, /s// qcma /g' -e '/,/s// qcma qbs /g' \
-e '/ \\$ /s// qdlr /g' -e '/\\$ /s// qbs qdlr /g' -e '/\\$/s// qbs qdlr qbs /g' \
-e '/ \\: /s// qcln /g' -e '/\\: /s// qbs qcln /g' -e '/\\:/s// qbs qcln qbs /g' \
-e '/ \\\\ /s// qbksls /g' -e '/\\\\ /s// qbs qbksls /g' -e '/\\\\/s// qbs qbksls qbs /g' \
-e '/ " /s// qspc qdqte /g' -e '/ "/s// qdqte qbs /g' -e '/"/s// qdqte qbs /g' \
-e "/ ' /s// qspc qsqte /g" -e "/ '/s// qsqte qbs /g" -e "s/'/ qbs qsqte qbs /g" \
-e '/       /s// qspcspcspcspcspcspc /g' -e '/      /s// qspcspcspcspcspc /g' -e '/     /s// qspcspcspcspc /g' -e '/    /s// qspcspcspc /g' -e '/   /s// qspcspc /g' -e '/  /s// qspc /g' \
`
do 
WRDCNT=`echo $WRDCNT+1 | bc`
echo $WORD | awk -v "wrdcnt=$WRDCNT"  '{n=split($1,a,""); 
if ((wrdcnt == 1) && (a[1] != toupper(a[1])) && (a[n] == tolower(a[n])) ) printf "lookupWordbz2 qlc";
else if ((a[1] != tolower(a[1]) && (a[n] != tolower(a[n])))) printf "lookupWordbz2 qallcap";
else if (wrdcnt > 1) {
      if ((a[1] != tolower(a[1]) && (a[n] == tolower(a[n])))) printf "lookupWordbz2 qfstcap"; 
      else if ((a[1] != tolower(a[1]) && (a[n] != tolower(a[n])))) printf "lookupWordbz2 qallcap";
      } 
}' | sh
WORD=`awk -v "word=$WORD" 'BEGIN{printf "%s",tolower(word);}'`
LOOK=$WORD
while true 
do
STRING=`lookupWordbz2 $LOOK`
if test "$?" -eq "1" 
then echo "$STRING";
   if test "$LOOK" = "$WORD"
   then break;
   else 
   # send a back space
       lookupWordbz2 qbs
       LOOK=`awk -v "word=$WORD" -v "look=$LOOK" 'BEGIN{printf "%s",substr(word,length(look)+1,length(word));}'`
       WORD=$LOOK       
   fi
else
   LOOK=`awk -v "word=$LOOK" 'BEGIN{printf "%s",substr(word,1,length(word)-1);}'`
fi
done
done | tee /tmp/coding | awk '{printf "tc_enc -f cmprsalpha %d\n",$2; fflush();}' | sh | awk '{ n=(length($0)+4) % 8; printf "1%d%d%d%s", int(n/4 % 2),int(n/2 % 2),int(n % 2),$0 ; if (n) {for (j=n; j <= 7; j++)  printf "0"; }}' | tee /tmp/fullstring \
| awk '{printf "obase=256; ibase=2; %s\n",$0}'  | bc | tr -d "\n" | tr -d '\' 2> /dev/null | tr " " "\n" \
| awk '{if (length($1)) printf "%c",$1}'  | tee  $FILE  >/dev/null # to be recoded as morse code
echo "message size " | tr -d "\n"
echo "$MESSAGE" | wc -c | tr -d " \n"
echo " (chars),  Outgoing message " | tr -d "\n"
wc -c < $FILE | tr -d " \n" 
echo " (bytes)"
fi
#done
#cat /tmp/fullstring
echo ""
rm cmprsalpha

exit 1

